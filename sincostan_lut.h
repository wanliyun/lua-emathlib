#ifndef _EMATH_LIB_SIN_COS_H
#define _EMATH_LIB_SIN_COS_H
#include <math.h>

#define EMATH_PI  (3.141592653589793238462643383279502884)
#define EMATH_PI_2  (EMATH_PI / 2)

static lua_Number emath_rad2deg(lua_Number r)
{
	return r * (180 / EMATH_PI);
}

static lua_Number emath_deg2rad(lua_Number deg)
{
	return deg * (EMATH_PI / 180);
}

/* save cos value in range [0-180] in degre, pre 0.5 deg */
static lua_Number deg2cosLUT[361]  = {
1.0000000000, 0.9999619231, 0.9998476952, 0.9996573250, 0.9993908270, 0.9990482216, 0.9986295348, 0.9981347984, 0.9975640503, 0.9969173337,
0.9961946981, 0.9953961984, 0.9945218954, 0.9935718557, 0.9925461516, 0.9914448614, 0.9902680687, 0.9890158634, 0.9876883406, 0.9862856015,
0.9848077530, 0.9832549076, 0.9816271834, 0.9799247046, 0.9781476007, 0.9762960071, 0.9743700648, 0.9723699204, 0.9702957263, 0.9681476404,
0.9659258263, 0.9636304532, 0.9612616959, 0.9588197349, 0.9563047560, 0.9537169507, 0.9510565163, 0.9483236552, 0.9455185756, 0.9426414911,
0.9396926208, 0.9366721892, 0.9335804265, 0.9304175680, 0.9271838546, 0.9238795325, 0.9205048535, 0.9170600744, 0.9135454576, 0.9099612709,
0.9063077870, 0.9025852843, 0.8987940463, 0.8949343616, 0.8910065242, 0.8870108332, 0.8829475929, 0.8788171127, 0.8746197071, 0.8703556959,
0.8660254038, 0.8616291604, 0.8571673007, 0.8526401644, 0.8480480962, 0.8433914458, 0.8386705679, 0.8338858221, 0.8290375726, 0.8241261886,
0.8191520443, 0.8141155184, 0.8090169944, 0.8038568606, 0.7986355100, 0.7933533403, 0.7880107536, 0.7826081569, 0.7771459615, 0.7716245834,
0.7660444431, 0.7604059656, 0.7547095802, 0.7489557208, 0.7431448255, 0.7372773368, 0.7313537016, 0.7253743710, 0.7193398003, 0.7132504492,
0.7071067812, 0.7009092643, 0.6946583705, 0.6883545757, 0.6819983601, 0.6755902076, 0.6691306064, 0.6626200482, 0.6560590290, 0.6494480483,
0.6427876097, 0.6360782203, 0.6293203910, 0.6225146366, 0.6156614753, 0.6087614290, 0.6018150232, 0.5948227868, 0.5877852523, 0.5807029557,
0.5735764364, 0.5664062369, 0.5591929035, 0.5519369853, 0.5446390350, 0.5372996083, 0.5299192642, 0.5224985647, 0.5150380749, 0.5075383630,
0.5000000000, 0.4924235601, 0.4848096202, 0.4771587603, 0.4694715628, 0.4617486132, 0.4539904997, 0.4461978131, 0.4383711468, 0.4305110968,
0.4226182617, 0.4146932427, 0.4067366431, 0.3987490689, 0.3907311285, 0.3826834324, 0.3746065934, 0.3665012267, 0.3583679495, 0.3502073813,
0.3420201433, 0.3338068592, 0.3255681545, 0.3173046564, 0.3090169944, 0.3007057995, 0.2923717047, 0.2840153447, 0.2756373558, 0.2672383761,
0.2588190451, 0.2503800041, 0.2419218956, 0.2334453639, 0.2249510543, 0.2164396139, 0.2079116908, 0.1993679344, 0.1908089954, 0.1822355255,
0.1736481777, 0.1650476059, 0.1564344650, 0.1478094111, 0.1391731010, 0.1305261922, 0.1218693434, 0.1132032138, 0.1045284633, 0.0958457525,
0.0871557427, 0.0784590957, 0.0697564737, 0.0610485395, 0.0523359562, 0.0436193874, 0.0348994967, 0.0261769483, 0.0174524064, 0.0087265355,
0.0000000000, -0.0087265355, -0.0174524064, -0.0261769483, -0.0348994967, -0.0436193874, -0.0523359562, -0.0610485395, -0.0697564737, -0.0784590957,
-0.0871557427, -0.0958457525, -0.1045284633, -0.1132032138, -0.1218693434, -0.1305261922, -0.1391731010, -0.1478094111, -0.1564344650, -0.1650476059,
-0.1736481777, -0.1822355255, -0.1908089954, -0.1993679344, -0.2079116908, -0.2164396139, -0.2249510543, -0.2334453639, -0.2419218956, -0.2503800041,
-0.2588190451, -0.2672383761, -0.2756373558, -0.2840153447, -0.2923717047, -0.3007057995, -0.3090169944, -0.3173046564, -0.3255681545, -0.3338068592,
-0.3420201433, -0.3502073813, -0.3583679495, -0.3665012267, -0.3746065934, -0.3826834324, -0.3907311285, -0.3987490689, -0.4067366431, -0.4146932427,
-0.4226182617, -0.4305110968, -0.4383711468, -0.4461978131, -0.4539904997, -0.4617486132, -0.4694715628, -0.4771587603, -0.4848096202, -0.4924235601,
-0.5000000000, -0.5075383630, -0.5150380749, -0.5224985647, -0.5299192642, -0.5372996083, -0.5446390350, -0.5519369853, -0.5591929035, -0.5664062369,
-0.5735764364, -0.5807029557, -0.5877852523, -0.5948227868, -0.6018150232, -0.6087614290, -0.6156614753, -0.6225146366, -0.6293203910, -0.6360782203,
-0.6427876097, -0.6494480483, -0.6560590290, -0.6626200482, -0.6691306064, -0.6755902076, -0.6819983601, -0.6883545757, -0.6946583705, -0.7009092643,
-0.7071067812, -0.7132504492, -0.7193398003, -0.7253743710, -0.7313537016, -0.7372773368, -0.7431448255, -0.7489557208, -0.7547095802, -0.7604059656,
-0.7660444431, -0.7716245834, -0.7771459615, -0.7826081569, -0.7880107536, -0.7933533403, -0.7986355100, -0.8038568606, -0.8090169944, -0.8141155184,
-0.8191520443, -0.8241261886, -0.8290375726, -0.8338858221, -0.8386705679, -0.8433914458, -0.8480480962, -0.8526401644, -0.8571673007, -0.8616291604,
-0.8660254038, -0.8703556959, -0.8746197071, -0.8788171127, -0.8829475929, -0.8870108332, -0.8910065242, -0.8949343616, -0.8987940463, -0.9025852843,
-0.9063077870, -0.9099612709, -0.9135454576, -0.9170600744, -0.9205048535, -0.9238795325, -0.9271838546, -0.9304175680, -0.9335804265, -0.9366721892,
-0.9396926208, -0.9426414911, -0.9455185756, -0.9483236552, -0.9510565163, -0.9537169507, -0.9563047560, -0.9588197349, -0.9612616959, -0.9636304532,
-0.9659258263, -0.9681476404, -0.9702957263, -0.9723699204, -0.9743700648, -0.9762960071, -0.9781476007, -0.9799247046, -0.9816271834, -0.9832549076,
-0.9848077530, -0.9862856015, -0.9876883406, -0.9890158634, -0.9902680687, -0.9914448614, -0.9925461516, -0.9935718557, -0.9945218954, -0.9953961984,
-0.9961946981, -0.9969173337, -0.9975640503, -0.9981347984, -0.9986295348, -0.9990482216, -0.9993908270, -0.9996573250, -0.9998476952, -0.9999619231,
-1.0000000000,
};

/* accuracy : 0.5 deg*/
static lua_Number emath_cos_tablelookup (lua_Number deg) {
	//printf("math_cos_tablelookup\n");
	long ideg = (long)round(deg * 2);
	ideg = abs(ideg);
	ideg = ideg % 720;
	ideg = ideg < 360 ? ideg : 720 - ideg;
	lua_Number ret = deg2cosLUT[ideg];
	//printf("math_cos_tablelookup %d %f", ideg, ret);
	return ret;
}


/* https://github.com/xiezhq-hermann/atan_lookup/blob/master/atan.cpp*/
 static float emath_atan_LUT[102] = {
     0,           0.0099996664, 0.019997334, 0.029991005, 0.039978687,
     0.049958397, 0.059928156,  0.069885999, 0.079829983, 0.089758173,
     0.099668652, 0.10955953,   0.11942893,  0.12927501,  0.13909595,
     0.14888994,  0.15865526,   0.16839015,  0.17809294,  0.18776195,
     0.19739556,  0.20699219,   0.21655031,  0.22606839,  0.23554498,
     0.24497867,  0.25436807,   0.26371184,  0.27300870,  0.28225741,
     0.29145679,  0.30060568,   0.30970293,  0.31874755,  0.32773849,
     0.33667481,  0.34555557,   0.35437992,  0.36314702,  0.37185606,
     0.38050637,  0.38909724,   0.39762798,  0.40609807,  0.41450688,
     0.42285392,  0.43113875,   0.43936089,  0.44751999,  0.45561564,
     0.46364760,  0.47161558,   0.47951928,  0.48735857,  0.49513325,
     0.50284320,  0.51048833,   0.51806855,  0.52558380,  0.53303409,
     0.54041952,  0.54774004,   0.55499572,  0.56218672,  0.56931317,
     0.57637525,  0.58337301,   0.59030676,  0.59717667,  0.60398299,
     0.61072594,  0.61740589,   0.62402308,  0.63057774,  0.63707036,
     0.64350110,  0.64987046,   0.65617871,  0.66242629,  0.66861355,
     0.67474097,  0.68080884,   0.68681765,  0.69276786,  0.69865984,
     0.70449406,  0.71027100,   0.71599114,  0.72165483,  0.72726268,
     0.73281509,  0.73831260,   0.74375558,  0.74914461,  0.75448018,
     0.75976276,  0.76499283,   0.77017093,  0.77529752,  0.78037310,
     0.78539819,  0.79037325};

static float emath_atan_fast(float x){
  /*
  A fast look-up method with enough accuracy
  */
  if (x >= 0) {
    if (x <= 1) {
      int index = round(x * 100);
      return emath_atan_LUT[index];
    } else {
      float re_x = 1 / x;
      int index = round(re_x * 100);
      return (EMATH_PI_2 - emath_atan_LUT[index]);
    }
  } else {
    if (x >= -1) {
      float abs_x = -x;
      int index = round(abs_x * 100);
      return -(emath_atan_LUT[index]);
    } else {
      float re_x = 1 / (-x);
      int index = round(re_x * 100);
      return (emath_atan_LUT[index] - EMATH_PI_2);
    }
  }
}

 static double emath_atan_LUT_d[102] = {
 0,                   0.00999966668666524, 0.0199973339731505,  0.0299910048568779,  0.0399786871232900,
 0.0499583957219428,  0.0599281551212079,  0.0698860016346425,  0.0798299857122373,  0.0897581741899505,
 0.0996686524911620,  0.109559526773944,   0.119428926018338,   0.129275004048143,   0.139095941482071,
 0.148889947609497,   0.158655262186401,   0.168390157147530,   0.178092938231198,   0.187761946513593,
 0.197395559849881,   0.206992194219821,   0.216550304976089,   0.226068387993884,   0.235544980720863,
 0.244978663126864,   0.254368058553266,   0.263711834462266,   0.273008703086711,   0.282257421981491,
 0.291456794477867,   0.300605670042395,   0.309702944542456,   0.318747560420644,   0.327738506780556,
 0.336674819386727,   0.345555580581712,   0.354379919123438,   0.363147009946176,   0.371856073848581,
 0.380506377112365,   0.389097231055278,   0.397627991522129,   0.406098058317616,   0.414506874584786,
 0.422853926132941,   0.431138740718782,   0.439360887284591,   0.447519975157170,   0.455615653211225,
 0.463647609000806,   0.471615567862328,   0.479519291992596,   0.487358579505190,   0.495133263468404,
 0.502843210927861,   0.510488321916776,   0.518068528456721,   0.525583793551610,   0.533034110177490,
 0.540419500270584,   0.547740013715902,   0.554995727338587,   0.562186743900029,   0.569313191100662,
 0.576375220591184,   0.583373006993856,   0.590306746935372,   0.597176658092678,   0.603982978252998,
 0.610725964389209,   0.617405891751573,   0.624023052976757,   0.630577757214935,   0.637070329275684,
 0.643501108793284,   0.649870449411948,   0.656178717991395,   0.662426293833151,   0.668613567927821,
 0.674740942223553,   0.680808828915828,   0.686817649758645,   0.692767835397122,   0.698659824721463,
 0.704494064242218,   0.710271007486686,   0.715991114416300,   0.721654850864761,   0.727262687996690,
 0.732815101786507,   0.738312572517228,   0.743755584298860,   0.749144624606017,   0.754480183834406,
 0.759762754875771,   0.764992832710910,   0.770170914020331,   0.775297496812126,   0.780373080066636,
 0.785398163397448,   0.790373246728302
 };

static double emath_atan_double(double x) {
  /*
  More precise look-up table is used for higher accuracy
  */
  if (x >= 0) {
    if (x <= 1) {
      int index = round(x * 100);
      return (emath_atan_LUT_d[index] + (x * 100 - index) * (emath_atan_LUT_d[index + 1] - emath_atan_LUT_d[index]));
    } else {
      double re_x = 1 / x;
      int index = round(re_x * 100);
      return (EMATH_PI_2 - (emath_atan_LUT_d[index] + (re_x * 100 - index) * (emath_atan_LUT_d[index + 1] - emath_atan_LUT_d[index])));
      // No recursive is better here
    }
  } else {
    if (x >= -1) {
      double abs_x = -x;
      int index = round(abs_x * 100);
      return -(emath_atan_LUT_d[index] + (abs_x * 100 - index) * (emath_atan_LUT_d[index + 1] - emath_atan_LUT_d[index]));
    } else {
      double re_x = 1 / (-x);
      int index = round(re_x * 100);
      return (emath_atan_LUT_d[index] + (re_x * 100 - index) * (emath_atan_LUT_d[index+1] - emath_atan_LUT_d[index])) - EMATH_PI_2;
    }
  }
}


#endif